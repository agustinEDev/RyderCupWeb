name: CI Pipeline

on:
  push:
    branches: [main, develop, 'feature/**', 'release/**', 'hotfix/**']
  pull_request:
    branches: [develop, main]

jobs:
  lint:
    name: üîç Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check code formatting (Prettier)
        run: |
          echo "‚ú® Checking code formatting with Prettier..."

          # Check if Prettier is installed
          if ! npm list prettier > /dev/null 2>&1; then
            echo "‚ö†Ô∏è Prettier not installed, skipping format check"
            exit 0
          fi

          # Run Prettier check
          npx prettier --check "src/**/*.{js,jsx,ts,tsx,css,json}" || {
            echo ""
            echo "‚ùå Code formatting issues found!"
            echo "üí° Run 'npx prettier --write .' to fix formatting"
            exit 1
          }

          echo "‚úÖ Code formatting is consistent"

      - name: Run ESLint
        run: npm run lint

  test:
    name: üß™ Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test -- --run --reporter=verbose

      - name: Generate coverage report
        run: npm test -- --run --coverage

      - name: Enforce coverage threshold
        run: |
          echo "üìä Checking coverage thresholds..."

          # Extract coverage percentages from coverage summary
          COVERAGE_FILE="coverage/coverage-summary.json"

          if [ ! -f "$COVERAGE_FILE" ]; then
            echo "‚ö†Ô∏è Coverage file not found, skipping threshold check"
            exit 0
          fi

          # Get global coverage percentages
          LINES=$(cat $COVERAGE_FILE | jq '.total.lines.pct')
          STATEMENTS=$(cat $COVERAGE_FILE | jq '.total.statements.pct')
          FUNCTIONS=$(cat $COVERAGE_FILE | jq '.total.functions.pct')
          BRANCHES=$(cat $COVERAGE_FILE | jq '.total.branches.pct')

          echo "  Lines: ${LINES}%"
          echo "  Statements: ${STATEMENTS}%"
          echo "  Functions: ${FUNCTIONS}%"
          echo "  Branches: ${BRANCHES}%"

          # Define minimum thresholds
          MIN_LINES=80
          MIN_STATEMENTS=80
          MIN_FUNCTIONS=75
          MIN_BRANCHES=70

          # Check thresholds
          FAIL=0

          if (( $(echo "$LINES < $MIN_LINES" | bc -l) )); then
            echo "‚ùå Lines coverage ($LINES%) is below threshold ($MIN_LINES%)"
            FAIL=1
          fi

          if (( $(echo "$STATEMENTS < $MIN_STATEMENTS" | bc -l) )); then
            echo "‚ùå Statements coverage ($STATEMENTS%) is below threshold ($MIN_STATEMENTS%)"
            FAIL=1
          fi

          if (( $(echo "$FUNCTIONS < $MIN_FUNCTIONS" | bc -l) )); then
            echo "‚ùå Functions coverage ($FUNCTIONS%) is below threshold ($MIN_FUNCTIONS%)"
            FAIL=1
          fi

          if (( $(echo "$BRANCHES < $MIN_BRANCHES" | bc -l) )); then
            echo "‚ùå Branches coverage ($BRANCHES%) is below threshold ($MIN_BRANCHES%)"
            FAIL=1
          fi

          if [ $FAIL -eq 1 ]; then
            echo ""
            echo "üí° Tip: Add more tests to increase coverage"
            exit 1
          fi

          echo "‚úÖ All coverage thresholds met!"

      - name: Upload coverage to artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30


  build:
    name: üèóÔ∏è Build Application
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Check build output
        run: |
          if [ ! -d "dist" ]; then
            echo "‚ùå Build failed: dist directory not found"
            exit 1
          fi
          echo "‚úÖ Build successful"
          ls -lah dist/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-output
          path: dist/
          retention-days: 7

  type-check:
    name: üìù Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for TypeScript files
        id: check-ts
        run: |
          if find src -name "*.ts" -o -name "*.tsx" | grep -q .; then
            echo "has_typescript=true" >> $GITHUB_OUTPUT
          else
            echo "has_typescript=false" >> $GITHUB_OUTPUT
          fi

      - name: Run type check
        if: steps.check-ts.outputs.has_typescript == 'true'
        run: npx tsc --noEmit || echo "‚ö†Ô∏è TypeScript check skipped or failed"

  code-quality:
    name: üìä Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesario para an√°lisis de cambios

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for dead code
        run: |
          echo "üîç Checking for unused exports..."
          npx knip --reporter json || echo "‚ö†Ô∏è knip not configured yet"
        continue-on-error: true

      - name: Check bundle size
        run: |
          npm run build
          echo "üì¶ Bundle size analysis:"

          # Get total bundle size
          TOTAL_SIZE=$(du -sb dist/assets/*.js 2>/dev/null | awk '{s+=$1} END {print s}')

          if [ -z "$TOTAL_SIZE" ]; then
            echo "‚ö†Ô∏è No JS bundles found"
            exit 0
          fi

          # Convert to KB
          TOTAL_SIZE_KB=$((TOTAL_SIZE / 1024))

          echo "  Total JS bundle size: ${TOTAL_SIZE_KB} KB"

          # Define budget (in KB)
          MAX_BUNDLE_SIZE_KB=1000
          WARNING_THRESHOLD_KB=800

          # List all bundles with sizes
          echo ""
          echo "  Individual bundles:"
          du -h dist/assets/*.js | sort -h

          # Check against budget
          if [ $TOTAL_SIZE_KB -gt $MAX_BUNDLE_SIZE_KB ]; then
            echo ""
            echo "‚ùå Bundle size (${TOTAL_SIZE_KB} KB) exceeds budget (${MAX_BUNDLE_SIZE_KB} KB)!"
            echo "üí° Tip: Consider code splitting, tree shaking, or removing unused dependencies"
            exit 1
          elif [ $TOTAL_SIZE_KB -gt $WARNING_THRESHOLD_KB ]; then
            echo ""
            echo "‚ö†Ô∏è Bundle size (${TOTAL_SIZE_KB} KB) is approaching budget limit (${MAX_BUNDLE_SIZE_KB} KB)"
            echo "   Current usage: $(( TOTAL_SIZE_KB * 100 / MAX_BUNDLE_SIZE_KB ))%"
          else
            echo ""
            echo "‚úÖ Bundle size is within budget"
            echo "   Budget used: $(( TOTAL_SIZE_KB * 100 / MAX_BUNDLE_SIZE_KB ))% (${TOTAL_SIZE_KB}/${MAX_BUNDLE_SIZE_KB} KB)"
          fi

  all-checks:
    name: ‚úÖ All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, test, build, type-check, code-quality]
    if: always()
    steps:
      - name: Check job statuses
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "‚ùå One or more required checks failed"
            exit 1
          fi
          echo "‚úÖ All required checks passed!"

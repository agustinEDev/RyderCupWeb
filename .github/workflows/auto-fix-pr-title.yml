name: Auto-fix PR Title

on:
  pull_request:
    types: [opened, reopened, edited]

jobs:
  fix-pr-title:
    name: üîß Auto-fix PR Title for Conventional Commits
    runs-on: ubuntu-latest
    # Only run for Dependabot PRs
    if: github.actor == 'dependabot[bot]' || github.actor == 'dependabot-preview[bot]'
    permissions:
      pull-requests: write
    steps:
      - name: Capitalize PR title
        uses: actions/github-script@v7
        with:
          script: |
            const prTitle = context.payload.pull_request.title;
            console.log(`Original PR title: ${prTitle}`);

            // Check if title follows conventional commits format
            const conventionalCommitRegex = /^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9-]+\))?:\s*.+$/;

            if (!conventionalCommitRegex.test(prTitle)) {
              console.log('‚ùå PR title does not follow Conventional Commits format');
              return;
            }

            // Extract type, scope, and subject
            const match = prTitle.match(/^([a-z]+)(\([a-z0-9-]+\))?:\s*(.+)$/);

            if (!match) {
              console.log('‚ùå Could not parse PR title');
              return;
            }

            const [, type, scope, subject] = match;

            // Capitalize first letter of subject
            const capitalizedSubject = subject.charAt(0).toUpperCase() + subject.slice(1);

            // Build new title
            const newTitle = `${type}${scope || ''}: ${capitalizedSubject}`;

            // Only update if title changed
            if (newTitle === prTitle) {
              console.log('‚úÖ PR title already capitalized correctly');
              return;
            }

            console.log(`üîß Updating PR title to: ${newTitle}`);

            // Update PR title
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              title: newTitle
            });

            // Add a comment explaining the change
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `ü§ñ **Auto-fix applied**: PR title capitalized to comply with [Conventional Commits](https://www.conventionalcommits.org/).\n\n` +
                    `- **Before**: \`${prTitle}\`\n` +
                    `- **After**: \`${newTitle}\``
            });

            console.log('‚úÖ PR title updated successfully');

name: Security Audit

on:
  # Ejecutar semanalmente los lunes a las 9:00 AM
  schedule:
    - cron: '0 9 * * 1'
  
  # Ejecutar en PRs a develop y main (GitFlow)
  pull_request:
    branches: [develop, main]
  
  # Permitir ejecuci√≥n manual
  workflow_dispatch:

jobs:
  dependency-audit:
    name: üîí Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: audit
        run: |
          echo "üîç Running npm audit..."
          npm audit --audit-level=moderate --json > audit-report.json || true
          
          # Mostrar resumen
          npm audit --audit-level=moderate || true
          
          # Verificar vulnerabilidades cr√≠ticas/altas
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-report.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-report.json)
          
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "‚ùå Found $CRITICAL critical and $HIGH high vulnerabilities"
            exit 1
          fi
          
          echo "‚úÖ No critical or high vulnerabilities found"

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: audit-report.json
          retention-days: 30

  outdated-check:
    name: üì¶ Outdated Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for outdated dependencies
        run: |
          echo "üìã Checking for outdated dependencies..."
          npm outdated --long --json > outdated-report.json || true
          npm outdated || echo "Some dependencies are outdated (non-blocking)"

      - name: Analyze major updates
        run: |
          echo "üîç Analyzing major version updates..."
          if [ -s outdated-report.json ]; then
            MAJOR_UPDATES=$(jq 'to_entries | map(select(.value.latest != .value.current and (.value.latest | split(".")[0]) != (.value.current | split(".")[0]))) | length' outdated-report.json)
            echo "Found $MAJOR_UPDATES major version updates available"
            
            if [ "$MAJOR_UPDATES" -gt 0 ]; then
              echo "‚ö†Ô∏è Major updates available - review recommended"
              jq -r 'to_entries | map(select(.value.latest != .value.current and (.value.latest | split(".")[0]) != (.value.current | split(".")[0]))) | .[] | "  - \(.key): \(.value.current) ‚Üí \(.value.latest)"' outdated-report.json
            fi
          fi
        continue-on-error: true

      - name: Upload outdated report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: outdated-dependencies-report
          path: outdated-report.json
          retention-days: 30

  license-check:
    name: ‚öñÔ∏è License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check licenses
        run: |
          echo "‚öñÔ∏è Checking package licenses..."
          npx license-checker --summary || echo "license-checker not available"
          
          # Verificar licencias problem√°ticas
          npx license-checker --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD;CC0-1.0" --production || echo "‚ö†Ô∏è Some licenses may need review"
        continue-on-error: true

  security-scan:
    name: üõ°Ô∏è Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for secrets in code
        run: |
          echo "üîç Scanning for exposed secrets..."
          # Buscar patrones comunes de secrets
          ! grep -r -i "api[_-]key\s*=\s*['\"][a-zA-Z0-9]" src/ || echo "‚ö†Ô∏è Possible API key found"
          ! grep -r -i "password\s*=\s*['\"][^'\"]*['\"]" src/ || echo "‚ö†Ô∏è Possible hardcoded password found"
          ! grep -r -i "secret\s*=\s*['\"][a-zA-Z0-9]" src/ || echo "‚ö†Ô∏è Possible secret found"
          echo "‚úÖ No obvious secrets detected"
        continue-on-error: true

      - name: Check environment variables usage
        run: |
          echo "üîç Checking environment variable usage..."
          grep -r "import.meta.env" src/ || echo "No environment variables used"

  csp-validation:
    name: üîê CSP Headers Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate CSP headers
        run: |
          echo "üîç Validating Content Security Policy..."
          
          # Verificar que no hay unsafe-inline en producci√≥n
          if grep -i "unsafe-inline" public/_headers 2>/dev/null; then
            echo "‚ùå Found unsafe-inline in production CSP headers"
            exit 1
          fi
          
          if grep -i "unsafe-inline" vercel.json 2>/dev/null && ! grep -B5 "unsafe-inline" vercel.json | grep -q "development"; then
            echo "‚ùå Found unsafe-inline in production vercel.json"
            exit 1
          fi
          
          if grep -i "unsafe-inline" nginx.conf 2>/dev/null && ! grep -B5 "unsafe-inline" nginx.conf | grep -q "development"; then
            echo "‚ùå Found unsafe-inline in production nginx.conf"
            exit 1
          fi
          
          echo "‚úÖ CSP headers validation passed"

  all-security-checks:
    name: ‚úÖ All Security Checks
    runs-on: ubuntu-latest
    needs: [dependency-audit, outdated-check, license-check, security-scan, csp-validation]
    if: always()
    steps:
      - name: Check job statuses
        run: |
          if [ "${{ needs.dependency-audit.result }}" != "success" ] || \
             [ "${{ needs.csp-validation.result }}" != "success" ]; then
            echo "‚ùå Critical security checks failed"
            exit 1
          fi
          echo "‚úÖ All security checks passed!"
          
          if [ "${{ needs.license-check.result }}" != "success" ] || \
             [ "${{ needs.security-scan.result }}" != "success" ]; then
            echo "‚ö†Ô∏è Some non-critical checks had warnings"
          fi

name: CI/CD & Security Pipeline

on:
  push:
    branches: [main, develop, 'feature/**', 'release/**', 'hotfix/**']
  pull_request:
    branches: [develop, main]
  schedule:
    # Run security checks every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'

permissions:
  contents: read
  security-events: write

jobs:
  # ========================================
  # PHASE 1: SECURITY CHECKS (CRITICAL)
  # ========================================

  commit-verification:
    name: üîè Verify Commit Signatures
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Import GPG public keys
        env:
          GPG_KEYS: ${{ secrets.GPG_PUBLIC_KEYS }}
        run: |
          # Import GitHub's web-flow key (signs commits made via GitHub UI: merges, squash, rebase)
          echo "üîë Downloading GitHub web-flow GPG key..."
          GPG_TMP=$(mktemp)
          if ! curl -sSL --fail -o "$GPG_TMP" https://github.com/web-flow.gpg; then
            echo "‚ùå Failed to download GitHub web-flow GPG key"
            rm -f "$GPG_TMP"
            exit 1
          fi

          if [ ! -s "$GPG_TMP" ]; then
            echo "‚ùå Downloaded GPG key file is empty"
            rm -f "$GPG_TMP"
            exit 1
          fi

          echo "üîë Importing GitHub web-flow GPG key..."
          if ! gpg --import "$GPG_TMP"; then
            echo "‚ùå Failed to import GitHub web-flow GPG key"
            rm -f "$GPG_TMP"
            exit 1
          fi

          rm -f "$GPG_TMP"
          echo "‚úÖ GitHub web-flow GPG key imported successfully"

          # Import team GPG keys from repository secret
          if [ -n "$GPG_KEYS" ]; then
            echo "üîë Importing team GPG keys..."
            echo "$GPG_KEYS" | gpg --import
          else
            echo "‚ö†Ô∏è GPG_PUBLIC_KEYS secret not found. Only GitHub web-flow key imported."
          fi

      - name: Verify commit signature
        run: |
          COMMIT=$(git rev-parse HEAD)

          # Soft-fail check: Skip if team keys are not configured yet
          if [ -z "${{ secrets.GPG_PUBLIC_KEYS }}" ]; then
             echo "‚ö†Ô∏è GPG_PUBLIC_KEYS secret not configured. Skipping verification."
             exit 0
          fi

          if git verify-commit $COMMIT 2>&1 | grep -q "Good signature"; then
            echo "‚úÖ Commit $COMMIT signature verified"
          else
            echo "‚ùå Commit $COMMIT is NOT signed or signature is invalid"
            exit 1
          fi

  dependency-audit:
    name: üîí Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify package-lock.json integrity
        run: |
          echo "üîí Verifying package-lock.json was not modified..."

          git diff --exit-code package-lock.json || {
            echo "‚ùå package-lock.json was modified during npm ci!"
            echo "Run 'npm install' locally and commit the updated package-lock.json."
            exit 1
          }

          echo "‚úÖ package-lock.json integrity verified"

      - name: Run npm audit
        id: audit
        run: |
          echo "üîç Running npm audit..."
          npm audit --audit-level=moderate --json > audit-report.json || true

          # Parse results
          VULNERABILITIES=$(cat audit-report.json | jq '.metadata.vulnerabilities.total')
          CRITICAL=$(cat audit-report.json | jq '.metadata.vulnerabilities.critical')
          HIGH=$(cat audit-report.json | jq '.metadata.vulnerabilities.high')
          MODERATE=$(cat audit-report.json | jq '.metadata.vulnerabilities.moderate')

          echo "üìä Vulnerability Summary:"
          echo "  Critical: $CRITICAL"
          echo "  High: $HIGH"
          echo "  Moderate: $MODERATE"
          echo "  Total: $VULNERABILITIES"

          # Export to outputs
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "total=$VULNERABILITIES" >> $GITHUB_OUTPUT

          # Fail if critical or high vulnerabilities found
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "‚ùå Critical or High vulnerabilities found!"
            npm audit --audit-level=high
            exit 1
          fi

          # Warn if moderate vulnerabilities found
          if [ "$MODERATE" -gt 0 ]; then
            echo "‚ö†Ô∏è Moderate vulnerabilities found (allowed to pass)"
            npm audit --audit-level=moderate || true
          fi

          echo "‚úÖ No critical or high vulnerabilities found"

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: audit-report.json
          retention-days: 30

  secret-scanning:
    name: üîê Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS (Filesystem Scan)
        uses: trufflesecurity/trufflehog@v3.92.5
        with:
          path: ./
          extra_args: --debug --only-verified

  license-check:
    name: üìú License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check licenses
        run: |
          echo "üìú Checking dependency licenses..."
          npx license-checker --json --out licenses.json

          # Check for problematic licenses
          FORBIDDEN_LICENSES="GPL-3.0 AGPL-3.0 LGPL-3.0"

          for license in $FORBIDDEN_LICENSES; do
            if npx license-checker --summary | grep -q "$license"; then
              echo "‚ùå Forbidden license found: $license"
              npx license-checker --summary
              exit 1
            fi
          done

          echo "‚úÖ All licenses are compliant"
          npx license-checker --summary

      - name: Upload license report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: licenses.json
          retention-days: 30

  snyk-security:
    name: üêç Snyk Dependency Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@v1.0.0
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --sarif-file-output=snyk-security.sarif

      - name: Check if SARIF file exists
        id: check_sarif
        run: |
          if [ -f "snyk-security.sarif" ]; then
            echo "sarif_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ SARIF file generated successfully"
          else
            echo "sarif_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è SARIF file not generated (no vulnerabilities or Snyk error)"
          fi

      - name: Upload Snyk report to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: steps.check_sarif.outputs.sarif_exists == 'true'
        with:
          sarif_file: snyk-security.sarif

      - name: Upload Snyk SARIF report artifact
        if: steps.check_sarif.outputs.sarif_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: snyk-security-report
          path: snyk-security.sarif
          retention-days: 30

  snyk-code:
    name: üîç Snyk Code Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Snyk Code to check for code vulnerabilities
        uses: snyk/actions/node@v1.0.0
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test
          args: --severity-threshold=high --sarif-file-output=snyk-code.sarif

      - name: Check if SARIF file exists
        id: check_sarif_code
        run: |
          if [ -f "snyk-code.sarif" ]; then
            echo "sarif_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ SARIF file generated successfully"
          else
            echo "sarif_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è SARIF file not generated (no vulnerabilities or Snyk error)"
          fi

      - name: Upload Snyk Code report to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: steps.check_sarif_code.outputs.sarif_exists == 'true'
        with:
          sarif_file: snyk-code.sarif

      - name: Upload Snyk Code report artifact
        if: steps.check_sarif_code.outputs.sarif_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: snyk-code-report
          path: snyk-code.sarif
          retention-days: 30

  outdated-dependencies:
    name: üì¶ Outdated Dependencies Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for outdated packages
        id: outdated
        run: |
          echo "üì¶ Checking for outdated dependencies..."
          npm outdated --json > outdated.json || true

          # Count outdated packages
          OUTDATED_COUNT=$(cat outdated.json | jq 'length')

          echo "üìä Found $OUTDATED_COUNT outdated packages"
          echo "count=$OUTDATED_COUNT" >> $GITHUB_OUTPUT

          if [ "$OUTDATED_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è Outdated packages found (informational only, does not fail CI):"
            npm outdated || true
          else
            echo "‚úÖ All packages are up to date"
          fi

      - name: Upload outdated report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: outdated-dependencies
          path: outdated.json
          retention-days: 30

  # ========================================
  # PHASE 2: CODE QUALITY & TESTING
  # ========================================

  lint:
    name: üîç Lint & Format Check
    runs-on: ubuntu-latest
    needs: [dependency-audit, secret-scanning, license-check]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check code formatting (Prettier)
        run: |
          echo "‚ú® Checking code formatting with Prettier..."

          # Check if Prettier is installed
          if ! npm list prettier > /dev/null 2>&1; then
            echo "‚ö†Ô∏è Prettier not installed, skipping format check"
            exit 0
          fi

          # Run Prettier check
          npx prettier --check "src/**/*.{js,jsx,ts,tsx,css,json}" || {
            echo ""
            echo "‚ùå Code formatting issues found!"
            echo "üí° Run 'npx prettier --write .' to fix formatting"
            exit 1
          }

          echo "‚úÖ Code formatting is consistent"

      - name: Run ESLint
        run: npm run lint

  test:
    name: üß™ Run Tests
    runs-on: ubuntu-latest
    needs: [dependency-audit, secret-scanning, license-check]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test -- --run --reporter=verbose

      - name: Generate coverage report
        id: coverage
        run: |
          npm test -- --run --coverage

          # Extract coverage percentages from coverage summary
          COVERAGE_FILE="coverage/coverage-summary.json"

          if [ ! -f "$COVERAGE_FILE" ]; then
            echo "‚ö†Ô∏è Coverage file not found, skipping threshold check"
            exit 0
          fi

          # Get global coverage percentages
          LINES=$(cat $COVERAGE_FILE | jq '.total.lines.pct')
          STATEMENTS=$(cat $COVERAGE_FILE | jq '.total.statements.pct')
          FUNCTIONS=$(cat $COVERAGE_FILE | jq '.total.functions.pct')
          BRANCHES=$(cat $COVERAGE_FILE | jq '.total.branches.pct')

          echo "lines=$LINES" >> $GITHUB_OUTPUT
          echo "statements=$STATEMENTS" >> $GITHUB_OUTPUT
          echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT
          echo "branches=$BRANCHES" >> $GITHUB_OUTPUT

          echo "üìä Coverage Report:"
          echo "  Lines: ${LINES}%"
          echo "  Statements: ${STATEMENTS}%"
          echo "  Functions: ${FUNCTIONS}%"
          echo "  Branches: ${BRANCHES}%"

      - name: Enforce coverage threshold
        run: |
          echo "üìä Checking coverage thresholds..."

          # Extract coverage percentages from coverage summary
          COVERAGE_FILE="coverage/coverage-summary.json"

          if [ ! -f "$COVERAGE_FILE" ]; then
            echo "‚ö†Ô∏è Coverage file not found, skipping threshold check"
            exit 0
          fi

          # Get global coverage percentages
          LINES=$(cat $COVERAGE_FILE | jq '.total.lines.pct')
          STATEMENTS=$(cat $COVERAGE_FILE | jq '.total.statements.pct')
          FUNCTIONS=$(cat $COVERAGE_FILE | jq '.total.functions.pct')
          BRANCHES=$(cat $COVERAGE_FILE | jq '.total.branches.pct')

          echo "  Lines: ${LINES}%"
          echo "  Statements: ${STATEMENTS}%"
          echo "  Functions: ${FUNCTIONS}%"
          echo "  Branches: ${BRANCHES}%"

          # Define minimum thresholds
          MIN_LINES=80
          MIN_STATEMENTS=80
          MIN_FUNCTIONS=75
          MIN_BRANCHES=70

          # Check thresholds
          FAIL=0

          if (( $(echo "$LINES < $MIN_LINES" | bc -l) )); then
            echo "‚ùå Lines coverage ($LINES%) is below threshold ($MIN_LINES%)"
            FAIL=1
          fi

          if (( $(echo "$STATEMENTS < $MIN_STATEMENTS" | bc -l) )); then
            echo "‚ùå Statements coverage ($STATEMENTS%) is below threshold ($MIN_STATEMENTS%)"
            FAIL=1
          fi

          if (( $(echo "$FUNCTIONS < $MIN_FUNCTIONS" | bc -l) )); then
            echo "‚ùå Functions coverage ($FUNCTIONS%) is below threshold ($MIN_FUNCTIONS%)"
            FAIL=1
          fi

          if (( $(echo "$BRANCHES < $MIN_BRANCHES" | bc -l) )); then
            echo "‚ùå Branches coverage ($BRANCHES%) is below threshold ($MIN_BRANCHES%)"
            FAIL=1
          fi

          if [ $FAIL -eq 1 ]; then
            echo ""
            echo "üí° Tip: Add more tests to increase coverage"
            exit 1
          fi

          echo "‚úÖ All coverage thresholds met!"

      - name: Upload coverage to artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  type-check:
    name: üìù Type Check
    runs-on: ubuntu-latest
    needs: [dependency-audit, secret-scanning, license-check]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for TypeScript files
        id: check-ts
        run: |
          if find src -name "*.ts" -o -name "*.tsx" | grep -q .; then
            echo "has_typescript=true" >> $GITHUB_OUTPUT
          else
            echo "has_typescript=false" >> $GITHUB_OUTPUT
          fi

      - name: Run type check
        if: steps.check-ts.outputs.has_typescript == 'true'
        run: npx tsc --noEmit

  code-quality:
    name: üìä Code Quality
    runs-on: ubuntu-latest
    needs: [dependency-audit, secret-scanning, license-check]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for dead code
        run: |
          echo "üîç Checking for unused exports..."
          npx knip --reporter json || echo "‚ö†Ô∏è knip not configured yet"
        continue-on-error: true

      - name: Check bundle size
        id: bundle
        run: |
          npm run build
          echo "üì¶ Bundle size analysis:"

          # Get total bundle size
          TOTAL_SIZE=$(du -sb dist/assets/*.js 2>/dev/null | awk '{s+=$1} END {print s}')

          if [ -z "$TOTAL_SIZE" ]; then
            echo "‚ö†Ô∏è No JS bundles found"
            exit 0
          fi

          # Convert to KB
          TOTAL_SIZE_KB=$((TOTAL_SIZE / 1024))

          echo "  Total JS bundle size: ${TOTAL_SIZE_KB} KB"
          echo "size_kb=$TOTAL_SIZE_KB" >> $GITHUB_OUTPUT

          # Define budget (in KB)
          # v2.1: Reduced from 1600 KB to 1400 KB after replacing country-flag-icons (239 KB) with CDN images
          MAX_BUNDLE_SIZE_KB=1400
          WARNING_THRESHOLD_KB=1300

          # List all bundles with sizes
          echo ""
          echo "  Individual bundles:"
          du -h dist/assets/*.js | sort -h

          # Check against budget
          if [ $TOTAL_SIZE_KB -gt $MAX_BUNDLE_SIZE_KB ]; then
            echo ""
            echo "‚ùå Bundle size (${TOTAL_SIZE_KB} KB) exceeds budget (${MAX_BUNDLE_SIZE_KB} KB)!"
            echo "üí° Tip: Consider code splitting, tree shaking, or removing unused dependencies"
            exit 1
          elif [ $TOTAL_SIZE_KB -gt $WARNING_THRESHOLD_KB ]; then
            echo ""
            echo "‚ö†Ô∏è Bundle size (${TOTAL_SIZE_KB} KB) is approaching budget limit (${MAX_BUNDLE_SIZE_KB} KB)"
            echo "   Current usage: $(( TOTAL_SIZE_KB * 100 / MAX_BUNDLE_SIZE_KB ))%"
          else
            echo ""
            echo "‚úÖ Bundle size is within budget"
            echo "   Budget used: $(( TOTAL_SIZE_KB * 100 / MAX_BUNDLE_SIZE_KB ))% (${TOTAL_SIZE_KB}/${MAX_BUNDLE_SIZE_KB} KB)"
          fi

  # ========================================
  # PHASE 3: BUILD
  # ========================================

  build:
    name: üèóÔ∏è Build Application
    runs-on: ubuntu-latest
    needs: [commit-verification, lint, test, type-check, code-quality]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Check build output
        run: |
          if [ ! -d "dist" ]; then
            echo "‚ùå Build failed: dist directory not found"
            exit 1
          fi
          echo "‚úÖ Build successful"
          ls -lah dist/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/
          retention-days: 7

  # ========================================
  # PHASE 4: PIPELINE SUMMARY
  # ========================================

  pipeline-summary:
    name: üìä Pipeline Summary
    runs-on: ubuntu-latest
    needs: [dependency-audit, secret-scanning, license-check, snyk-security, snyk-code, outdated-dependencies, lint, test, type-check, code-quality, build]
    if: always()
    steps:
      - name: Generate Pipeline Summary
        run: |
          echo "# üèÜ CI/CD & Security Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** \`${{ github.workflow }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Security Phase
          echo "## üîí Phase 1: Security Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY

          # Dependency Audit
          if [ "${{ needs.dependency-audit.result }}" == "success" ]; then
            echo "| üîí Dependency Audit | ‚úÖ Passed | No critical/high vulnerabilities |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üîí Dependency Audit | ‚ùå Failed | Critical/high vulnerabilities found |" >> $GITHUB_STEP_SUMMARY
          fi

          # Secret Scanning
          if [ "${{ needs.secret-scanning.result }}" == "success" ]; then
            echo "| üîê Secret Scanning | ‚úÖ Passed | No secrets detected |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üîê Secret Scanning | ‚ùå Failed | Secrets found in code |" >> $GITHUB_STEP_SUMMARY
          fi

          # License Check
          if [ "${{ needs.license-check.result }}" == "success" ]; then
            echo "| üìú License Compliance | ‚úÖ Passed | All licenses compliant |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üìú License Compliance | ‚ùå Failed | Forbidden licenses detected |" >> $GITHUB_STEP_SUMMARY
          fi

          # Snyk Security
          if [ "${{ needs.snyk-security.result }}" == "success" ]; then
            echo "| üêç Snyk Dependencies | ‚úÖ Passed | No vulnerabilities |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.snyk-security.result }}" == "skipped" ]; then
            echo "| üêç Snyk Dependencies | ‚è≠Ô∏è Skipped | Token not configured |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üêç Snyk Dependencies | ‚ö†Ô∏è Warning | Check details |" >> $GITHUB_STEP_SUMMARY
          fi

          # Snyk Code
          if [ "${{ needs.snyk-code.result }}" == "success" ]; then
            echo "| üîç Snyk Code Analysis | ‚úÖ Passed | No code vulnerabilities |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.snyk-code.result }}" == "skipped" ]; then
            echo "| üîç Snyk Code Analysis | ‚è≠Ô∏è Skipped | Token not configured |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üîç Snyk Code Analysis | ‚ö†Ô∏è Warning | Check details |" >> $GITHUB_STEP_SUMMARY
          fi

          # Outdated Dependencies
          if [ "${{ needs.outdated-dependencies.result }}" == "success" ]; then
            echo "| üì¶ Outdated Deps | ‚ÑπÔ∏è Info | Check artifacts for details |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Quality Phase
          echo "## üéØ Phase 2: Code Quality & Testing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY

          # Lint
          if [ "${{ needs.lint.result }}" == "success" ]; then
            echo "| üîç Lint & Format | ‚úÖ Passed | Code style is consistent |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.lint.result }}" == "skipped" ]; then
            echo "| üîç Lint & Format | ‚è≠Ô∏è Skipped | Security checks failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üîç Lint & Format | ‚ùå Failed | Linting errors found |" >> $GITHUB_STEP_SUMMARY
          fi

          # Test
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "| üß™ Tests & Coverage | ‚úÖ Passed | All tests passed, coverage OK |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test.result }}" == "skipped" ]; then
            echo "| üß™ Tests & Coverage | ‚è≠Ô∏è Skipped | Security checks failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üß™ Tests & Coverage | ‚ùå Failed | Tests failed or coverage low |" >> $GITHUB_STEP_SUMMARY
          fi

          # Type Check
          if [ "${{ needs.type-check.result }}" == "success" ]; then
            echo "| üìù Type Check | ‚úÖ Passed | TypeScript types are valid |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.type-check.result }}" == "skipped" ]; then
            echo "| üìù Type Check | ‚è≠Ô∏è Skipped | No TypeScript or security failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üìù Type Check | ‚ùå Failed | Type errors found |" >> $GITHUB_STEP_SUMMARY
          fi

          # Code Quality
          if [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "| üìä Code Quality | ‚úÖ Passed | Bundle size OK, no dead code |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.code-quality.result }}" == "skipped" ]; then
            echo "| üìä Code Quality | ‚è≠Ô∏è Skipped | Security checks failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üìä Code Quality | ‚ùå Failed | Bundle too large or quality issues |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Build Phase
          echo "## üèóÔ∏è Phase 3: Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY

          # Build
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "| üèóÔ∏è Build Application | ‚úÖ Passed | Production build successful |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build.result }}" == "skipped" ]; then
            echo "| üèóÔ∏è Build Application | ‚è≠Ô∏è Skipped | Previous checks failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üèóÔ∏è Build Application | ‚ùå Failed | Build errors detected |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Final Status
          echo "## üéØ Final Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if all critical jobs passed
          if [ "${{ needs.dependency-audit.result }}" == "success" ] && \
             [ "${{ needs.secret-scanning.result }}" == "success" ] && \
             [ "${{ needs.license-check.result }}" == "success" ] && \
             [ "${{ needs.lint.result }}" == "success" ] && \
             [ "${{ needs.test.result }}" == "success" ] && \
             [ "${{ needs.build.result }}" == "success" ]; then
            echo "### ‚úÖ Pipeline Passed Successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All critical checks have passed. Your code is ready for deployment! üöÄ" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Pipeline Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more critical checks failed. Please review the errors above and fix them before proceeding." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Failed Jobs:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            [ "${{ needs.dependency-audit.result }}" != "success" ] && echo "- üîí Dependency Audit" >> $GITHUB_STEP_SUMMARY
            [ "${{ needs.secret-scanning.result }}" != "success" ] && echo "- üîê Secret Scanning" >> $GITHUB_STEP_SUMMARY
            [ "${{ needs.license-check.result }}" != "success" ] && echo "- üìú License Compliance" >> $GITHUB_STEP_SUMMARY
            [ "${{ needs.lint.result }}" != "success" ] && [ "${{ needs.lint.result }}" != "skipped" ] && echo "- üîç Lint & Format" >> $GITHUB_STEP_SUMMARY
            [ "${{ needs.test.result }}" != "success" ] && [ "${{ needs.test.result }}" != "skipped" ] && echo "- üß™ Tests & Coverage" >> $GITHUB_STEP_SUMMARY
            [ "${{ needs.type-check.result }}" != "success" ] && [ "${{ needs.type-check.result }}" != "skipped" ] && echo "- üìù Type Check" >> $GITHUB_STEP_SUMMARY
            [ "${{ needs.code-quality.result }}" != "success" ] && [ "${{ needs.code-quality.result }}" != "skipped" ] && echo "- üìä Code Quality" >> $GITHUB_STEP_SUMMARY
            [ "${{ needs.build.result }}" != "success" ] && [ "${{ needs.build.result }}" != "skipped" ] && echo "- üèóÔ∏è Build" >> $GITHUB_STEP_SUMMARY

            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated on $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
